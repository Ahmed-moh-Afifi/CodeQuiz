<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:CodeQuizDesktop.Models"
             xmlns:vm="clr-namespace:CodeQuizDesktop.Viewmodels"
             x:Class="CodeQuizDesktop.Views.Dashboard"
             x:DataType="vm:DashboardVM"
             xmlns:toolkit="clr-namespace:CommunityToolkit.Maui.Behaviors;assembly=CommunityToolkit.Maui">
    <ScrollView>
        <VerticalStackLayout Padding="32,24" Spacing="28">
            
            <!-- Header Section -->
            <VerticalStackLayout Spacing="6">
                <Label Text="Dashboard" Style="{StaticResource PageTitle}"/>
                <Label Text="Welcome back! Here's an overview of your activity." Style="{StaticResource CaptionText}"/>
            </VerticalStackLayout>

            <!-- Hero Section - Dynamic based on context -->
            <Border Style="{StaticResource ElevatedCard}" Padding="0" StrokeShape="RoundRectangle 20">
                <Grid ColumnDefinitions="*,Auto">
                    <!-- Left: Content -->
                    <VerticalStackLayout Padding="28" Spacing="16" VerticalOptions="Start">
                        <!-- When there are running attempts -->
                        <VerticalStackLayout Spacing="16" IsVisible="{Binding HasRunningAttempts}">
                            <HorizontalStackLayout Spacing="10">
                                <Border BackgroundColor="{StaticResource Running}" StrokeThickness="0" StrokeShape="RoundRectangle 6" Padding="8,4">
                                    <Label Text="● IN PROGRESS" FontSize="11" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                                </Border>
                            </HorizontalStackLayout>
                            <VerticalStackLayout Spacing="8">
                                <Label Text="You have an active quiz!" FontSize="26" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                                <Label Text="Don't forget to complete your attempt before time runs out." Style="{StaticResource BodyText}" TextColor="{StaticResource TextSecondary}" HorizontalOptions="Start"/>
                            </VerticalStackLayout>
                            <Button Text="Continue Quiz →" Style="{StaticResource PrimaryButton}" HorizontalOptions="Start" Margin="0,8,0,0"
                                    Command="{Binding ContinueFirstRunningCommand}"/>
                        </VerticalStackLayout>
                        
                        <!-- When no running attempts - Show quick join -->
                        <VerticalStackLayout Spacing="16" IsVisible="{Binding HasRunningAttempts, Converter={StaticResource InverseBoolConverter}}">
                            <VerticalStackLayout Spacing="8">
                                <Label Text="Ready to test your skills?" FontSize="26" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                                <Label Text="Join a quiz with a code or create your own challenge for others." Style="{StaticResource BodyText}" TextColor="{StaticResource TextSecondary}" MaximumWidthRequest="400" HorizontalOptions="Start"/>
                            </VerticalStackLayout>
                            <HorizontalStackLayout Spacing="12" Margin="0,8,0,0">
                                <Button Text="Join Quiz" Style="{StaticResource PrimaryButton}" Command="{Binding ViewAllJoinedCommand}"/>
                                <Button Text="Create Quiz" Style="{StaticResource SecondaryButton}" Command="{Binding ViewAllCreatedCommand}"/>
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                    
                    <!-- Right: Decorative Code Block (JSON style like VSCode) -->
                    <Border Grid.Column="1" BackgroundColor="{StaticResource BackgroundDark}" StrokeThickness="0" 
                            Padding="24" Margin="0" WidthRequest="300"
                            StrokeShape="RoundRectangle 0,20,0,20">
                        <VerticalStackLayout Spacing="4" VerticalOptions="Center">
                            <Label Text="{}{" FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource TextPrimary}"/>
                            <HorizontalStackLayout Spacing="0" Margin="16,0,0,0">
                                <Label Text="&quot;joined&quot;" FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource CodeKeyword}"/>
                                <Label Text=": " FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource TextPrimary}"/>
                                <Label Text="{Binding JoinedAttempts.Count}" FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource CodeString}"/>
                                <Label Text="," FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource TextPrimary}"/>
                            </HorizontalStackLayout>
                            <HorizontalStackLayout Spacing="0" Margin="16,0,0,0">
                                <Label Text="&quot;created&quot;" FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource CodeKeyword}"/>
                                <Label Text=": " FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource TextPrimary}"/>
                                <Label Text="{Binding CreatedQuizzes.Count}" FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource CodeString}"/>
                                <Label Text="," FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource TextPrimary}"/>
                            </HorizontalStackLayout>
                            <HorizontalStackLayout Spacing="0" Margin="16,0,0,0">
                                <Label Text="&quot;active&quot;" FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource CodeKeyword}"/>
                                <Label Text=": " FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource TextPrimary}"/>
                                <Label Text="{Binding UpcomingQuizzes.Count}" FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource CodeString}"/>
                                <Label Text="," FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource TextPrimary}"/>
                            </HorizontalStackLayout>
                            <HorizontalStackLayout Spacing="0" Margin="16,0,0,0">
                                <Label Text="&quot;status&quot;" FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource CodeKeyword}"/>
                                <Label Text=": " FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource TextPrimary}"/>
                                <Label Text="&quot;ready&quot;" FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource CodeString}"/>
                            </HorizontalStackLayout>
                            <Label Text="}" FontFamily="SFMonoRegular" FontSize="13" TextColor="{StaticResource TextPrimary}"/>
                            <BoxView HeightRequest="1" Color="{StaticResource BorderDefault}" Margin="0,8"/>
                            <Label Text="//Keep challenging, Keep coding!" FontFamily="SFMonoRegular" FontSize="12" TextColor="{StaticResource TextMuted}"/>
                        </VerticalStackLayout>
                    </Border>
                </Grid>
            </Border>

            <!-- Cards Grid -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="24">
                
                <!-- Joined Quizzes Card -->
                <Border Grid.Column="0" Style="{StaticResource ElevatedCard}">
                    <VerticalStackLayout Spacing="20">
                        <!-- Card Header -->
                        <Grid ColumnDefinitions="*,Auto">
                            <HorizontalStackLayout Spacing="12">
                                <Border BackgroundColor="{StaticResource PrimaryTransparent}" StrokeThickness="0" StrokeShape="RoundRectangle 8" Padding="8">
                                    <Image Source="quiz.png" WidthRequest="18" HeightRequest="18">
                                        <Image.Behaviors>
                                            <toolkit:IconTintColorBehavior TintColor="{StaticResource Primary}"/>
                                        </Image.Behaviors>
                                    </Image>
                                </Border>
                                <Label Text="Joined Quizzes" Style="{StaticResource SectionHeader}" VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                            <Border Grid.Column="1" BackgroundColor="Transparent" StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ViewAllJoinedCommand}"/>
                                </Border.GestureRecognizers>
                                <Label Text="View All →" Style="{StaticResource CaptionText}" TextColor="{StaticResource Primary}"/>
                            </Border>
                        </Grid>

                        <!-- Joined Quizzes List -->
                        <CollectionView ItemsSource="{Binding JoinedAttempts}" MaximumHeightRequest="400">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Vertical" ItemSpacing="5"/>
                            </CollectionView.ItemsLayout>
                            <CollectionView.EmptyView>
                                <Border Style="{StaticResource InnerCard}" Padding="24">
                                    <HorizontalStackLayout Spacing="16" HorizontalOptions="Center">
                                        <Border BackgroundColor="{StaticResource Secondary}" StrokeThickness="0" StrokeShape="RoundRectangle 10" Padding="12">
                                            <Image Source="question.svg" WidthRequest="24" HeightRequest="24">
                                                <Image.Behaviors>
                                                    <toolkit:IconTintColorBehavior TintColor="{StaticResource TextMuted}"/>
                                                </Image.Behaviors>
                                            </Image>
                                        </Border>
                                        <VerticalStackLayout Spacing="4" VerticalOptions="Center">
                                            <Label Text="No quizzes joined yet" TextColor="{StaticResource TextSecondary}" FontSize="15" FontAttributes="Bold"/>
                                            <Label Text="Join one using a quiz code" TextColor="{StaticResource TextMuted}" FontSize="13"/>
                                        </VerticalStackLayout>
                                    </HorizontalStackLayout>
                                </Border>
                            </CollectionView.EmptyView>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:ExamineeAttempt">
                                    <Border Style="{StaticResource InnerCard}" Margin="0,0,0,12">
                                        <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="14">
                                            <Grid ColumnDefinitions="*,Auto">
                                                <Label Text="{Binding Quiz.Title}" Style="{StaticResource ItemTitle}"/>
                                                <Border Grid.Column="1" Style="{StaticResource LiveBadge}" IsVisible="{Binding IsRunning}">
                                                    <Label Text="LIVE" Style="{StaticResource BadgeText}"/>
                                                </Border>
                                                <Border Grid.Column="1" Style="{StaticResource SuccessBadge}" IsVisible="{Binding IsCompleted}">
                                                    <Label Text="COMPLETED" Style="{StaticResource BadgeText}"/>
                                                </Border>
                                            </Grid>
                                            <VerticalStackLayout Grid.Row="1" Spacing="4">
                                                <Label Text="{Binding Quiz.Examiner.FullName, StringFormat='Created by: {0}'}" Style="{StaticResource CaptionText}"/>
                                                <Label Text="{Binding Quiz.QustionsCount, StringFormat='{0} Questions'}" Style="{StaticResource CaptionText}"/>
                                            </VerticalStackLayout>
                                            
                                            <!-- Running: Show time started -->
                                            <HorizontalStackLayout Grid.Row="2" Spacing="6" IsVisible="{Binding IsRunning}">
                                                <Label Text="Started:" Style="{StaticResource CaptionText}"/>
                                                <Label Text="{Binding StartTimeLocal, StringFormat='{0:MMM dd, HH:mm}'}" Style="{StaticResource ScoreText}"/>
                                            </HorizontalStackLayout>
                                            
                                            <!-- Completed: Show score -->
                                            <HorizontalStackLayout Grid.Row="2" Spacing="6" IsVisible="{Binding IsCompleted}">
                                                <Label Text="Score:" Style="{StaticResource CaptionText}"/>
                                                <Label Text="{Binding GradePercentage, StringFormat='{0:F1}%'}" Style="{StaticResource SuccessText}"/>
                                            </HorizontalStackLayout>
                                            
                                            <!-- Running: Continue button -->
                                            <Button Grid.Row="3" Text="Continue ▶" Style="{StaticResource PrimaryButton}" IsVisible="{Binding IsRunning}"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardVM}}, Path=ContinueAttemptCommand}" 
                                                    CommandParameter="{Binding .}"/>
                                            
                                            <!-- Completed: View Results button -->
                                            <Button Grid.Row="3" Text="View Results" Style="{StaticResource SecondaryButton}" IsVisible="{Binding IsCompleted}"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardVM}}, Path=ViewResultsCommand}" 
                                                    CommandParameter="{Binding .}"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Border>

                <!-- Created Quizzes Card -->
                <Border Grid.Column="1" Style="{StaticResource ElevatedCard}">
                    <VerticalStackLayout Spacing="20">
                        <!-- Card Header -->
                        <Grid ColumnDefinitions="*,Auto">
                            <HorizontalStackLayout Spacing="12">
                                <Border BackgroundColor="{StaticResource SuccessTransparent}" StrokeThickness="0" StrokeShape="RoundRectangle 8" Padding="8">
                                    <Image Source="teacher.png" WidthRequest="18" HeightRequest="18">
                                        <Image.Behaviors>
                                            <toolkit:IconTintColorBehavior TintColor="{StaticResource Success}"/>
                                        </Image.Behaviors>
                                    </Image>
                                </Border>
                                <Label Text="Created Quizzes" Style="{StaticResource SectionHeader}" VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                            <Border Grid.Column="1" BackgroundColor="Transparent" StrokeThickness="0">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ViewAllCreatedCommand}"/>
                                </Border.GestureRecognizers>
                                <Label Text="Manage All →" Style="{StaticResource CaptionText}" TextColor="{StaticResource Primary}"/>
                            </Border>
                        </Grid>

                        <!-- Created Quizzes List -->
                        <CollectionView ItemsSource="{Binding CreatedQuizzes}" MaximumHeightRequest="400">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Vertical" ItemSpacing="5"/>
                            </CollectionView.ItemsLayout>
                            <CollectionView.EmptyView>
                                <Border Style="{StaticResource InnerCard}" Padding="24">
                                    <VerticalStackLayout Spacing="12" HorizontalOptions="Center">
                                        <Border BackgroundColor="{StaticResource Secondary}" StrokeThickness="0" StrokeShape="RoundRectangle 10" Padding="12" HorizontalOptions="Center">
                                            <Image Source="pencil.svg" WidthRequest="24" HeightRequest="24">
                                                <Image.Behaviors>
                                                    <toolkit:IconTintColorBehavior TintColor="{StaticResource TextMuted}"/>
                                                </Image.Behaviors>
                                            </Image>
                                        </Border>
                                        <Label Text="No quizzes created yet" TextColor="{StaticResource TextSecondary}" FontSize="15" FontAttributes="Bold" HorizontalOptions="Center"/>
                                        <Label Text="Create your first quiz to get started" TextColor="{StaticResource TextMuted}" FontSize="13" HorizontalOptions="Center"/>
                                        <Button Text="+ New Quiz" Style="{StaticResource OutlinedButton}" Margin="0,4,0,0" Command="{Binding ViewAllCreatedCommand}"/>
                                    </VerticalStackLayout>
                                </Border>
                            </CollectionView.EmptyView>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:ExaminerQuiz">
                                    <Border Style="{StaticResource InnerCard}" Margin="0,0,0,12">
                                        <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="14">
                                            <Grid ColumnDefinitions="*,Auto">
                                                <Label Text="{Binding Title}" Style="{StaticResource ItemTitle}"/>
                                                <!-- Status Badges -->
                                                <Border Grid.Column="1" Style="{StaticResource LiveBadge}" IsVisible="{Binding IsRunning}">
                                                    <Label Text="RUNNING" Style="{StaticResource BadgeText}"/>
                                                </Border>
                                                <Border Grid.Column="1" Style="{StaticResource WarningBadge}" IsVisible="{Binding IsUpcoming}">
                                                    <Label Text="UPCOMING" Style="{StaticResource BadgeText}" TextColor="{StaticResource BackgroundDark}"/>
                                                </Border>
                                                <Border Grid.Column="1" Style="{StaticResource StatusBadge}" IsVisible="{Binding IsEnded}">
                                                    <Label Text="ENDED" Style="{StaticResource BadgeText}"/>
                                                </Border>
                                            </Grid>
                                            
                                            <!-- Stats Row -->
                                            <Grid Grid.Row="1" ColumnDefinitions="*,*,*" ColumnSpacing="8">
                                                <VerticalStackLayout Spacing="2">
                                                    <Label Text="{Binding QustionsCount}" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                                                    <Label Text="Questions" Style="{StaticResource CaptionText}" FontSize="11"/>
                                                </VerticalStackLayout>
                                                <VerticalStackLayout Grid.Column="1" Spacing="2">
                                                    <Label Text="{Binding AttemptsCount}" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}"/>
                                                    <Label Text="Participants" Style="{StaticResource CaptionText}" FontSize="11"/>
                                                </VerticalStackLayout>
                                                <VerticalStackLayout Grid.Column="2" Spacing="2">
                                                    <Label Text="{Binding AveragePercentage, StringFormat='{0:F0}%'}" FontSize="18" FontAttributes="Bold" TextColor="{StaticResource Success}"/>
                                                    <Label Text="Avg Score" Style="{StaticResource CaptionText}" FontSize="11"/>
                                                </VerticalStackLayout>
                                            </Grid>
                                            
                                            <!-- Quiz Code -->
                                            <Border Grid.Row="2" Style="{StaticResource StatusBadge}" Padding="12,10">
                                                <HorizontalStackLayout Spacing="8">
                                                    <Label Text="Code:" Style="{StaticResource CaptionText}"/>
                                                    <Label Text="{Binding Code}" FontFamily="SFMonoRegular" FontAttributes="Bold" TextColor="{StaticResource Primary}"/>
                                                </HorizontalStackLayout>
                                            </Border>
                                            
                                            <!-- Action Buttons -->
                                            <Grid Grid.Row="3" ColumnDefinitions="*,*" ColumnSpacing="10">
                                                <Button Text="View" Style="{StaticResource SecondaryButton}" Padding="0,12"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardVM}}, Path=ViewCreatedQuizCommand}" 
                                                        CommandParameter="{Binding .}"/>
                                                <Button Grid.Column="1" Text="Delete" Style="{StaticResource DangerButton}" Padding="0,12"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:DashboardVM}}, Path=DeleteCreatedQuizCommand}" 
                                                        CommandParameter="{Binding .}"/>
                                            </Grid>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Border>
            </Grid>
        </VerticalStackLayout>
    </ScrollView>
</ContentView>
