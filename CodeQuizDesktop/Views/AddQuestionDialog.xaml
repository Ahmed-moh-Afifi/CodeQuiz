<?xml version="1.0" encoding="utf-8" ?>
<toolkit:Popup xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:rv="http://sharpnado.com"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="CodeQuizDesktop.Views.AddQuestionDialog"
             xmlns:local="clr-namespace:CodeQuizDesktop.Controls"
             xmlns:models="clr-namespace:CodeQuizDesktop.Models"
             BackgroundColor="Transparent"
             Padding="0"
             Margin="0"
             CanBeDismissedByTappingOutsideOfPopup="False"
             x:TypeArguments="models:NewQuestionModel"
             xmlns:views="clr-namespace:CodeQuizDesktop.Views">
             
    <Border StrokeThickness="0" StrokeShape="RoundRectangle 20" Background="Transparent" Margin="0">
        <Grid VerticalOptions="Center" HorizontalOptions="Center">
            <Border Style="{StaticResource DialogContainer}" MaximumHeightRequest="900" WidthRequest="720" HeightRequest="900" Padding="0" VerticalOptions="Center" HorizontalOptions="Center">
                <Grid RowDefinitions="Auto,*,Auto">
                    
                    <!-- Dialog Header -->
                    <Grid Style="{StaticResource DialogHeader}" ColumnDefinitions="*,Auto">
                        <Label Text="Add Question" Style="{StaticResource SectionHeader}" VerticalOptions="Center"/>
                        <Border Grid.Column="1" Style="{StaticResource CloseButton}">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnCloseButtonClicked"/>
                            </Border.GestureRecognizers>
                            <Label Text="âœ•" FontSize="16" TextColor="{StaticResource TextPrimary}" HorizontalOptions="Center" VerticalOptions="Center"/>
                        </Border>
                    </Grid>
                    
                    <BoxView HeightRequest="1" Color="{StaticResource BorderDefault}" VerticalOptions="End"/>
                    
                    <!-- Dialog Body -->
                    <ScrollView Grid.Row="1">
                        <VerticalStackLayout Padding="24" Spacing="20">
                            
                            <!-- Question Statement -->
                            <VerticalStackLayout Spacing="8">
                                <Label Text="Question Statement" Style="{StaticResource ItemTitle}"/>
                                <Border Style="{StaticResource MultilineInputBorder}">
                                    <Editor MaximumHeightRequest="150" AutoSize="TextChanges" Style="{StaticResource TextEditor}" Text="{Binding Statement}"/>
                                </Border>
                            </VerticalStackLayout>
                            
                            <!-- Points -->
                            <VerticalStackLayout Spacing="8">
                                <Label Text="Points" Style="{StaticResource ItemTitle}"/>
                                <Border Style="{StaticResource InputBorder}">
                                    <Entry Text="{Binding Points}" Keyboard="Numeric" Style="{StaticResource TextInput}" VerticalTextAlignment="Center"/>
                                </Border>
                            </VerticalStackLayout>
                            
                            <!-- Starter Code -->
                            <VerticalStackLayout Spacing="8">
                                <Label Text="Starter Code in Editor" Style="{StaticResource ItemTitle}"/>
                                <Border Stroke="{StaticResource BorderDefault}" StrokeThickness="1" StrokeShape="RoundRectangle 12">
                                    <local:CodeEditor EditorType="IntellisenseOnly" Code="{Binding EditorCode}" x:Name="code" HeightRequest="400"/>
                                </Border>
                            </VerticalStackLayout>
                            
                            <!-- Test Cases -->
                            <VerticalStackLayout Spacing="12">
                                <Label Text="Test Cases" Style="{StaticResource ItemTitle}"/>
                                
                                <CollectionView ItemsSource="{Binding TestCases}">
                                    <CollectionView.ItemsLayout>
                                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="12"/>
                                    </CollectionView.ItemsLayout>
                                    <CollectionView.EmptyView>
                                        <Border Style="{StaticResource InnerCard}" Padding="32">
                                            <Label Text="No test cases added yet" Style="{StaticResource CaptionText}" HorizontalOptions="Center" VerticalOptions="Center"/>
                                        </Border>
                                    </CollectionView.EmptyView>
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Border Style="{StaticResource InnerCard}" Padding="0">
                                                <VerticalStackLayout Spacing="0">
                                                    <!-- Test Case Header -->
                                                    <Grid Padding="16" BackgroundColor="{StaticResource BackgroundDark}">
                                                        <Label Text="{Binding TestCaseNumber, StringFormat='Test Case {0}'}" Style="{StaticResource ItemTitle}" VerticalOptions="Center"/>
                                                        <Border Style="{StaticResource DangerIconButton}" HorizontalOptions="End">
                                                            <Border.GestureRecognizers>
                                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type views:AddQuestionDialog}}, Path=DeleteTestCaseCommand}" CommandParameter="{Binding .}"/>
                                                            </Border.GestureRecognizers>
                                                            <Image Source="trash.png" WidthRequest="18" HeightRequest="18" InputTransparent="True">
                                                                <Image.Behaviors>
                                                                    <toolkit:IconTintColorBehavior TintColor="{StaticResource Error}"/>
                                                                </Image.Behaviors>
                                                            </Image>
                                                        </Border>
                                                    </Grid>
                                                    
                                                    <BoxView HeightRequest="1" Color="{StaticResource BorderDefault}"/>
                                                    
                                                    <!-- Test Case Content -->
                                                    <VerticalStackLayout Spacing="16" Padding="16">
                                                        <VerticalStackLayout Spacing="6">
                                                            <Label Text="Input" Style="{StaticResource CaptionText}"/>
                                                            <Border Style="{StaticResource MultilineInputBorder}" BackgroundColor="{StaticResource Secondary}" Padding="0">
                                                                <Editor Text="{Binding InputInOneString}" MaximumHeightRequest="120" AutoSize="TextChanges" Style="{StaticResource TextEditor}"/>
                                                            </Border>
                                                        </VerticalStackLayout>
                                                        <VerticalStackLayout Spacing="6">
                                                            <Label Text="Expected Output" Style="{StaticResource CaptionText}"/>
                                                            <Border Style="{StaticResource MultilineInputBorder}" BackgroundColor="{StaticResource Secondary}" Stroke="{StaticResource Success}" Padding="0">
                                                                <Editor Text="{Binding ExpectedOutput}" MaximumHeightRequest="120" AutoSize="TextChanges" TextColor="{StaticResource Success}"/>
                                                            </Border>
                                                        </VerticalStackLayout>
                                                    </VerticalStackLayout>
                                                </VerticalStackLayout>
                                            </Border>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                                
                                <!-- Add Test Case Button -->
                                <Border Style="{StaticResource AddItemButton}" Margin="0,8">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding AddTestCaseCommand}"/>
                                    </Border.GestureRecognizers>
                                    <Label Text="+ Add Test Case" TextColor="{StaticResource Primary}" HorizontalTextAlignment="Center" FontAttributes="Bold"/>
                                </Border>
                            </VerticalStackLayout>
                            
                            <!-- Independent Configuration Toggle -->
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Text="Configure this question independently" Style="{StaticResource BodyText}" VerticalOptions="Center"/>
                                <Switch Grid.Column="1" Style="{StaticResource PrimarySwitch}" IsToggled="{Binding IndependentlyConfigured}"/>
                            </Grid>
                            
                            <!-- Independent Configuration Panel -->
                            <Border Style="{StaticResource InnerCard}" IsVisible="{Binding IndependentlyConfigured}">
                                <VerticalStackLayout Spacing="16">
                                    <VerticalStackLayout Spacing="8">
                                        <Label Text="Programming Language" Style="{StaticResource CaptionText}"/>
                                        <Border Style="{StaticResource InputBorder}" BackgroundColor="{StaticResource Secondary}">
                                            <Picker ItemsSource="{Binding ProgrammingLanguages}" SelectedItem="{Binding ProgrammingLanguage}"/>
                                        </Border>
                                    </VerticalStackLayout>
                                    
                                    <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,*" RowSpacing="12">
                                        <HorizontalStackLayout Grid.Column="0" Grid.Row="0" Spacing="12">
                                            <CheckBox Style="{StaticResource PrimaryCheckBox}" IsChecked="{Binding AllowIntellisense}" MinimumWidthRequest="0"/>
                                            <Label Text="Allow IntelliSense" Style="{StaticResource BodyText}" VerticalOptions="Center"/>
                                        </HorizontalStackLayout>
                                        <HorizontalStackLayout Grid.Column="1" Grid.Row="0" Spacing="12">
                                            <CheckBox Style="{StaticResource PrimaryCheckBox}" IsChecked="{Binding AllowSignatureHelp}" MinimumWidthRequest="0"/>
                                            <Label Text="Allow Signature Help" Style="{StaticResource BodyText}" VerticalOptions="Center"/>
                                        </HorizontalStackLayout>
                                        <HorizontalStackLayout Grid.Column="0" Grid.Row="1" Spacing="12">
                                            <CheckBox Style="{StaticResource PrimaryCheckBox}" IsChecked="{Binding AllowExecution}" MinimumWidthRequest="0"/>
                                            <Label Text="Allow Code Execution" Style="{StaticResource BodyText}" VerticalOptions="Center"/>
                                        </HorizontalStackLayout>
                                        <HorizontalStackLayout Grid.Column="1" Grid.Row="1" Spacing="12" IsVisible="{Binding AllowExecution}">
                                            <CheckBox Style="{StaticResource PrimaryCheckBox}" IsChecked="{Binding ShowOutput}" MinimumWidthRequest="0"/>
                                            <Label Text="Show Output" Style="{StaticResource BodyText}" VerticalOptions="Center"/>
                                        </HorizontalStackLayout>
                                        <HorizontalStackLayout Grid.Column="0" Grid.Row="2" Spacing="12" IsVisible="{Binding AllowExecution}">
                                            <CheckBox Style="{StaticResource PrimaryCheckBox}" IsChecked="{Binding ShowError}" MinimumWidthRequest="0"/>
                                            <Label Text="Show Errors" Style="{StaticResource BodyText}" VerticalOptions="Center"/>
                                        </HorizontalStackLayout>
                                    </Grid>
                                </VerticalStackLayout>
                            </Border>
                        </VerticalStackLayout>
                    </ScrollView>
                    
                    <!-- Dialog Footer -->
                    <Border Grid.Row="2" Style="{StaticResource DialogFooter}" StrokeShape="RoundRectangle 0,0,16,16">
                        <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                            <Button Text="Cancel" Style="{StaticResource SecondaryButton}" Clicked="OnCloseButtonClicked"/>
                            <Button Grid.Column="1" Text="Save Question" Style="{StaticResource PrimaryButton}" Clicked="OnAddButtonClicked"/>
                        </Grid>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </Border>
</toolkit:Popup>